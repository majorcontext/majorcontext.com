---
---

<div id="theme-toggle" class="relative">
  <button
    id="theme-toggle-btn"
    class="text-stone-600 hover:text-stone-800 dark:text-stone-400 dark:hover:text-stone-300 transition-colors focus-visible:outline-2 focus-visible:outline-sky-600 focus-visible:outline-offset-2"
    aria-label="Theme"
    aria-haspopup="true"
    aria-expanded="false"
  >
    <!-- Sun (light) icon -->
    <svg id="theme-icon-light" class="w-5 h-5 relative top-[3px] hidden" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24" aria-hidden="true">
      <path stroke-linecap="round" stroke-linejoin="round" d="M12 3v2.25m6.364.386-1.591 1.591M21 12h-2.25m-.386 6.364-1.591-1.591M12 18.75V21m-4.773-4.227-1.591 1.591M5.25 12H3m4.227-4.773L5.636 5.636M15.75 12a3.75 3.75 0 1 1-7.5 0 3.75 3.75 0 0 1 7.5 0Z" />
    </svg>
    <!-- Moon (dark) icon -->
    <svg id="theme-icon-dark" class="w-5 h-5 relative top-[3px] hidden" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24" aria-hidden="true">
      <path stroke-linecap="round" stroke-linejoin="round" d="M21.752 15.002A9.72 9.72 0 0 1 18 15.75c-5.385 0-9.75-4.365-9.75-9.75 0-1.33.266-2.597.748-3.752A9.753 9.753 0 0 0 3 11.25C3 16.635 7.365 21 12.75 21a9.753 9.753 0 0 0 9.002-5.998Z" />
    </svg>
  </button>

  <div
    id="theme-dropdown"
    class="hidden absolute right-0 top-full mt-2 py-1 min-w-[8rem] bg-stone-100 dark:bg-stone-800 border border-stone-300 dark:border-stone-700 rounded shadow-lg"
    role="menu"
  >
    <button role="menuitem" data-theme="light" class="theme-option flex items-center gap-2 w-full text-left px-3 py-1.5 text-xs text-stone-600 dark:text-stone-400 hover:bg-stone-200 dark:hover:bg-stone-700 transition-colors">
      <span class="theme-check w-3 text-sky-700 dark:text-sky-400 invisible">&#10003;</span>
      Light
    </button>
    <button role="menuitem" data-theme="dark" class="theme-option flex items-center gap-2 w-full text-left px-3 py-1.5 text-xs text-stone-600 dark:text-stone-400 hover:bg-stone-200 dark:hover:bg-stone-700 transition-colors">
      <span class="theme-check w-3 text-sky-700 dark:text-sky-400 invisible">&#10003;</span>
      Dark
    </button>
    <button role="menuitem" data-theme="system" class="theme-option flex items-center gap-2 w-full text-left px-3 py-1.5 text-xs text-stone-600 dark:text-stone-400 hover:bg-stone-200 dark:hover:bg-stone-700 transition-colors">
      <span class="theme-check w-3 text-sky-700 dark:text-sky-400 invisible">&#10003;</span>
      System
    </button>
  </div>
</div>

<script>
  import { getTheme, getResolvedTheme, applyTheme, initThemeListener } from '../scripts/theme';
  import type { Theme } from '../scripts/theme';

  function updateIcon(): void {
    const resolved = getResolvedTheme();
    document.getElementById('theme-icon-light')!.classList.toggle('hidden', resolved !== 'light');
    document.getElementById('theme-icon-dark')!.classList.toggle('hidden', resolved !== 'dark');
  }

  function updateActiveOption(): void {
    const current = getTheme();
    document.querySelectorAll('.theme-option').forEach((btn) => {
      const isActive = (btn as HTMLElement).dataset.theme === current;
      const check = btn.querySelector('.theme-check')!;
      check.classList.toggle('invisible', !isActive);
    });
  }

  function setOpen(open: boolean): void {
    const btn = document.getElementById('theme-toggle-btn')!;
    const dropdown = document.getElementById('theme-dropdown')!;
    btn.setAttribute('aria-expanded', String(open));
    dropdown.classList.toggle('hidden', !open);
  }

  function init(): void {
    const btn = document.getElementById('theme-toggle-btn')!;
    const dropdown = document.getElementById('theme-dropdown')!;

    updateIcon();
    updateActiveOption();

    btn.addEventListener('click', () => {
      const isOpen = btn.getAttribute('aria-expanded') === 'true';
      setOpen(!isOpen);
    });

    dropdown.addEventListener('click', (e) => {
      const target = (e.target as HTMLElement).closest<HTMLElement>('.theme-option');
      if (!target) return;
      const theme = target.dataset.theme as Theme;
      applyTheme(theme);
      updateIcon();
      updateActiveOption();
      setOpen(false);
    });

    document.addEventListener('click', (e) => {
      if (!(e.target as HTMLElement).closest('#theme-toggle')) {
        setOpen(false);
      }
    });

    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') setOpen(false);
    });

    initThemeListener();
  }

  init();
  document.addEventListener('astro:after-swap', init);
</script>
